<?xml version="1.0"?>
<launch>
  <arg name="tag_file_name" default="2025/re540_n1_room111"/>
  <arg name="camera_name" default="camera"/>
  <arg name="image_topic" default="color/image_raw"/>
  <arg name="threshold_dist2tag" default="2.0"/>

  <arg name="world_frame_name" default="world"/>
  <arg name="camera_frame_name" default="camera_link"/>
  <arg name="image_frame_name" default="camera_link"/>

  <arg name="with_apriltag_ros" default="true"/>
  <arg name="with_visualization" default="true"/>
  <arg name="with_realsense_tf" default="false"/>
  <arg name="broadcast_world2cam_tf" default="false"/>

  <node pkg="nodelet" type="nodelet" name="depth_to_cloud"
        args="standalone depth_image_proc/point_cloud_xyz">
    <remap from="image_rect"   to="/camera/depth/image_rect_raw"/>
    <remap from="camera_info"  to="/camera/depth/camera_info"/>
    <remap from="points"       to="/camera/depth/points"/>
  </node>

  <!-- Generate local heightmap -->
  <node pkg="local_costmap_generator" type="heightmap_node" name="heightmap_node" output="screen">
    <param name="full_clouds" value="true" /> 
  </node>

  <!-- Local Costmap -->
  <node pkg="local_costmap_generator" type="heightmap_costmap_node" name="heightmap_costmap_node" output="screen">
  </node>

  <!-- Apriltag ROS Localization -->
  <group if="$(arg with_apriltag_ros)">
      <include file="$(find apriltag_ros)/launch/continuous_detection.launch">
          <arg name="camera_name" value="$(arg camera_name)"/>
          <arg name="image_topic" value="$(arg image_topic)"/>
      </include>
  </group>

  <node name="apriltag_localization_node" pkg="apriltag_localization" type="apriltag_localization_node" output="screen">
      <param name="tag_config_name" value="$(arg tag_file_name)"/>
      <param name="world_frame_name" value="$(arg world_frame_name)"/>
      <param name="camera_frame_name" value="$(arg camera_frame_name)"/>
      <param name="image_frame_name" value="$(arg image_frame_name)"/>
      <param name="broadcast_world2cam_tf" value="$(arg broadcast_world2cam_tf)"/>
      <param name="threshold_dist" value="$(arg threshold_dist2tag)"/>
  </node>

  <node pkg="tf2_ros" type="static_transform_publisher" name="cam_to_base"
        args="0.10 0.0 0.05 0 0 0 base_link camera_link" />

  <node pkg="tf2_ros" type="static_transform_publisher" name="base_to_world_tf"
      args="0 0 0 0 0 0 world base_link" />

  <!-- Apriltag Fusion -->
  <node pkg="orb_slam3_apriltag_fusion"
      type="fusion_node.py"
      name="orb_slam3_apriltag_fusion"
      output="screen"/>

  <!-- RVIZ visualization -->
  <node pkg="rviz" type="rviz" name="rviz" required="true"
          args="-d $(find rviz_visualization)/config-1.rviz"/>
          
</launch>
