<launch>
  <!-- CORRIDOR EXPLORATION -->
  <node pkg="robot_controller"
        type="local_map_wall_avoider.py"
        name="local_map_wall_avoider"
        output="screen">
    <!-- topics -->
    <param name="map_topic" value="/map/local_map/obstacle" />
    <param name="cmd_vel_topic" value="/cmd_vel" />
    <param name="turn_direction" value="LEFT" />

    <!-- behaviour params -->
    <param name="forward_speed" value="0.25" />
    <param name="rotation_speed" value="0.4" />
    <param name="rotation_angle" value="1.32" />  <!-- ~90 deg -->
    <param name="probe_angle" value="1.32" />      <!-- 45 deg -->
    <param name="safe_distance" value="0.5" />          <!-- upper bound -->
    <param name="max_scan_distance" value="0.7" />
    <param name="min_turn_distance" value="0.05" />      <!-- lower bound -->
    <param name="lateral_width" value="0.15" />
    <param name="obstacle_threshold" value="50" />
    <param name="forward_axis" value="x" />

     <!-- Optional tuning for corridor classification -->
    <param name="side_blocked_threshold" value="0.3" />
    <param name="side_open_threshold" value="0.5" />
  </node>

     <!-- APRILTAG APPROACHING -->
   <node pkg="robot_controller"
        type="apriltag_approaching.py"
        name="apriltag_approach"
        output="screen">
    <!-- Topics -->
    <param name="tag_topic"        value="/tag_detections"/>
    <param name="cmd_vel_topic"    value="/cmd_vel"/>
    <!-- Target pose -->
    <param name="target_distance"  value="0.72"/> <!-- desired z distance to tag [m] -->
    <param name="target_sideways"  value="0.04"/>
    <param name="target_id"        value="-1"/> <!-- -1: follow any tag, else specific ID -->
    <param name="advance_distance" value= "1.4"/>
    <param name="advance_speed"    value="0.45"/>
    <!-- Gains -->
    <param name="k_side"           value="3.8"/> <!-- lateral control (x) -->
    <param name="k_forward"        value="1.8"/> <!-- forward control (z) -->
    <param name="k_yaw"            value="3.2"/> <!-- rotation control (orientation.z) -->
    <!-- Velocity limits -->
    <param name="max_side_vel"     value="0.85"/> <!-- m/s -->
    <param name="max_forward_vel"  value="0.60"/> <!-- m/s -->
    <param name="max_yaw_vel"      value="0.10"/> <!-- rad/s -->
    <!-- Tolerances -->
    <param name="tol_x"            value="0.04"/> <!-- m, sideways alignment -->
    <param name="tol_z"            value="0.07"/> <!-- m, distance alignment -->
    <param name="tol_yaw"          value="0.04"/> <!-- unitless, orientation.z -->
    <!-- Misc -->
    <param name="timeout"          value="0.5"/> <!-- s, lose tag after this -->``
    <param name="control_rate"     value="20.0"/> <!-- Hz -->
  </node>

    <!-- SEMANTIC MAPPER-->
    <node pkg="semantic_mapping"
            type="semantic_mapper_node.py"
            name="semantic_mapper_node"
            output="screen">
        <!-- Topics -->
        <param name="yolo_topic"          value="/yolo_usb/center_point"/>
        <param name="pose_topic"          value="/orb_slam3/pose_corrected"/>
        <!-- Sampling Window -->
        <param name="initial_duration"    value="1.0"/> 
        <param name="max_duration"        value="2.0"/> 
    </node>
    
    <!-- HISTORICAL MAPPER-->
    <node pkg="semantic_mapping"
            type="historical_mapping_node.py"
            name="historical_mapping_node"
            output="screen">
    </node>

    <!-- SEMANTIC VISUALIZER for JUNCTION -->
    <node pkg="semantic_mapping"
        type="semantic_map_visualizer.py"
        name="semantic_map_visualizer"
        output="screen">
    <param name="frame_id" value="world" />
    <param name="check_rate" value="1.0" />
    <param name="semantic_map_path"
           value="$(find semantic_mapping)/maps/semantic_map.json" />
   </node>

   <!-- PRE ENTERING -->
   <node pkg="robot_controller"
        type="pre_entering_node.py"
        name="pre_entering_node"
        output="screen">
    <param name="forward_distance" value="2" />
    <param name="forward_speed" value="0.25" />
    <param name="rotation_speed" value="0.5"/>
    <param name="rotation_angle_deg" value="84"/>
    </node>

    <!-- ENTERING STORE-->
    <node pkg="robot_controller"
        type="entering_store_enhanced_node.py"
        name="entering_store_node"
        output="screen">
    <param name="det_timeout" value="3.0"/>
    <param name="sideways_timeout" value="30.0"/>
    <param name="scan_angle_deg" value="40.5"/>
    <param name="full_angle_deg" value="79"/>
    <param name="image_width" value="640" />
    <param name="image_height" value="480" />
    <param name="rotation_speed" value="0.5"/>
    <param name="forward_speed" value="0.5"/>
    <param name="side_speed" value="0.3"/>
    <param name="center_tolerance" value="30"/>
    </node>
    
    <!-- MAIN CONTROLLER -->
    <node pkg="robot_controller" type="main_controller.py" name="main_controller_node" output="screen">
    <param name="tag_timeout" value="1.0"/>
    <param name="semantic_mapping_duration" value="3.0"/>
    <param name="post_grasp_turn_degrees" value="79"/>
    <param name="tag_lost_far_threshold" value="0.73"/>
    <param name="post_grasp_backup_distance" value="1.0"/>  <!-- meters -->
    <param name="post_grasp_backup_speed" value="0.25"/> 
    </node>
    
    <!-- DECISION MAKER -->
    <node pkg="robot_controller" type="decision_makers.py" name="decision_makers_node" output="screen" />
    
    <!-- APPROACHING AND GRASPING -->
    <node pkg="robot_controller" type="object_approaching_grasping_enhanced.py" name="object_approaching_grasping_node" output="screen">
    <param name="min_instance_hits" value="3"/>
    <param name="min_instance_age" value="0.35"/>
    <param name="attempt_pose_bin" value="0.05"/>
    <param name="search_backup_dist" value="1.0"/>
    <param name="verify_stale_backup_time" value="0.9"/>
    <param name="target_depth" value="0.24"/>
    <param name="target_x" value="0.01"/>
    <param name="x_tolerance" value="0.005"/>
    <param name="z_tolerance" value="0.01"/>         
    </node>
    
    <!-- OBJECT PICKUP CONTROLLER -->
    <node pkg="robot_controller" type="object_pickup_controller.py" name="object_pickup_controller" output="screen">
        <param name="gate_topic" value="/activate_object_pickup"/>
        <param name="costmap_topic" value="/map/local_map/obstacle"/>
        <param name="cmd_vel_topic" value="/cmd_vel"/>
        <param name="rotate_degrees" value="160.0"/>
        <param name="forward_speed" value="0.3"/>
        <param name="rotate_speed" value="0.6"/>
        <param name="publish_hz" value="20"/>
    </node>

</launch>
